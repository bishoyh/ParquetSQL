name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Qt6
      run: |
        sudo apt-get update
        sudo apt-get install -y qt6-base-dev qt6-charts-dev libgl1-mesa-dev

    - name: Install DuckDB
      run: |
        wget https://github.com/duckdb/duckdb/releases/download/v1.1.3/libduckdb-linux-amd64.zip
        unzip -o libduckdb-linux-amd64.zip -d third_party/duckdb
        sudo cp third_party/duckdb/libduckdb.so /usr/local/lib/
        sudo mkdir -p /usr/local/include/duckdb
        sudo cp third_party/duckdb/duckdb.h /usr/local/include/
        sudo ldconfig

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release -j$(nproc)

    - name: Package
      run: |
        cd build
        strip ParquetSQL
        tar -czf ParquetSQL-linux-x86_64.tar.gz ParquetSQL

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ParquetSQL-linux-x86_64
        path: build/ParquetSQL-linux-x86_64.tar.gz

  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Qt6
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.7.0'
        modules: 'qtcharts'

    - name: Install DuckDB
      run: |
        Invoke-WebRequest -Uri "https://github.com/duckdb/duckdb/releases/download/v1.1.3/libduckdb-windows-amd64.zip" -OutFile "libduckdb.zip"
        Expand-Archive -Path "libduckdb.zip" -DestinationPath "third_party/duckdb"

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="${env:Qt6_DIR}" -DDuckDB_INCLUDE_DIR="${PWD}/third_party/duckdb" -DDuckDB_LIBRARY="${PWD}/third_party/duckdb/duckdb.lib"

    - name: Build
      run: cmake --build build --config Release

    - name: Package
      run: |
        cd build/Release
        copy ../../third_party/duckdb/duckdb.dll .
        windeployqt ParquetSQL.exe
        Compress-Archive -Path ParquetSQL.exe,*.dll,duckdb.dll -DestinationPath ../ParquetSQL-windows-x86_64.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ParquetSQL-windows-x86_64
        path: build/ParquetSQL-windows-x86_64.zip

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Qt6
      run: brew install qt@6

    - name: Install DuckDB
      run: |
        wget https://github.com/duckdb/duckdb/releases/download/v1.1.3/libduckdb-osx-universal.zip
        unzip -o libduckdb-osx-universal.zip -d third_party/duckdb
        sudo cp third_party/duckdb/libduckdb.dylib /usr/local/lib/
        sudo cp third_party/duckdb/duckdb.h /usr/local/include/

    - name: Configure CMake
      run: |
        export Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=$Qt6_DIR

    - name: Build
      run: cmake --build build --config Release -j$(sysctl -n hw.ncpu)

    - name: Package
      run: |
        cd build
        macdeployqt ParquetSQL.app -dmg
        mv ParquetSQL.dmg ParquetSQL-macos-universal.dmg

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ParquetSQL-macos-universal
        path: build/ParquetSQL-macos-universal.dmg
